\chapter{Implementace}

Tato kapitola popisuje implementaci dokumentace a komponent.

\section{Struktura logiky}
\label{sec:structure}

Všechna logika komponenty je zapouzdřena v primitivní funkci.
Tato funkce nese název \texttt{create*}, kde \texttt{*} je název komponenty.
Všechny komponenty mají stejnou signaturu funkce, která vrací objekt s následujícími \textit{properties}:

\begin{itemize}
    \item \textbf{props} --- objekt s ARIA a HTML atributy a \textit{event listeners}.
    \item \textbf{state} --- stav komponenty, většinou se jedná o vnitřní stav komponenty, který chceme vystavit uživateli komponenty.
    \item \textbf{reference} --- některé komponenty potřebují referenci na přímý HTML element, který se v Solid.js předává pomocí proměnných\footnote{\url{https://solidjs.com/tutorial/bindings_refs}} a direktiv\footnote{\url{https://solidjs.com/tutorial/bindings_directives}}.
\end{itemize}

Některé komponenty (například \fr{SpinButton}) mají více HTML elementů na které je potřeba navázat ARIA atributy a event listeners, proto jejich funkce vrací více \textbf{props} properties (například buttonProps, rootProps).
Při více \textbf{props} properties je potřeba navázat danou property na odpovídající HTML element, který je zmíněn v dokumentaci.

Koncový uživatel tuto primitivní funkci zavolá v definici komponenty a předá jí všechny potřebné argumenty.
Manuálně naváže \textbf{props} na HTML elementy, předá potřebné \textbf{reference} a využije \textbf{state} pro vykreslení stavu komponenty.
Výhodou tohoto přístupu z kapitoly~\ref{technology:dist} je, že vývojář má absolutní kontrolu nad HTML strukturou komponenty a použitým CSS řešením.
\clearpage

\begin{lstlisting}[caption={Příklad implementace komponenty pomocí primitivní funkce}, label={implementation-example}, language=html]
import { createExample, type ExampleArgs } from "lib"
import type { Component } from "solid-js";

export const Example: Component<ExampleArgs> = (args) => {
    const {
        rootProps,
        buttonProps,
        state
    } = createExample(args)(*@\label{docs-page-example-9}@*)

    return (
        <div {...rootProps}>(*@\label{docs-page-example-12}@*)
            <button {...buttonProps}>Toggle</button>(*@\label{docs-page-example-13}@*)
            {state.isVisible ? <p>Content</p> : null}(*@\label{docs-page-example-14}@*)
        </div>
    )
}
\end{lstlisting}

Na ukázce~\ref{implementation-example} je příklad použití primitivní funkce \texttt{createExample} pro vytvoření komponenty \texttt{Example}.
Řádek~\ref{docs-page-example-9} zavolá primitivní funkci a předá jí argumenty, které jsou definovány v \texttt{ExampleArgs}.
Elementům na řádku~\ref{docs-page-example-12} a~\ref{docs-page-example-13} jsou předány atributy a event listeners pomocí spread operátoru.
Na řádku~\ref{docs-page-example-14} je ukázka využití vnitřního stavu komponenty pro vykreslení obsahu.

\subsection{Adresářová struktura}

Každá komponenta má svůj adresář, který obsahuje všechny soubory týkající se její implementace:

\vspace{11pt}

\dirtree{%
    .1 example.
    .2 \textbf{example.spec.ts} (jednotkové testy).
    .2 \textbf{example.ts} (logika komponenty).
    .2 \textbf{index.ts} (barrel export z types.ts a example.ts).
    .2 \textbf{types.ts} (definice typů pro komponentu).
}

\section{Carousel}

TODO

\section{Disclosure}

TODO

\section{SpinButton}

TODO

\section{Toolbar}

Stěžejní logikou komponenty \fr{Toolbar} je klávesová navigace.
Zásadní je správné chování focusu, které jsem přejal z knihovny React Aria, které má robustní řešení s ohledem na různé druhy prohlížečů a kombinace odečítačů obrazovky.

Přejaté soubory jsou popsané níže:

\begin{itemize}
    \item \textbf{dom-helpers.ts} --- Pomocné funkce pro získání správného \texttt{ownerDocument} a \texttt{ownerWindow} objektu z \gls{dom}.
    \item \textbf{focus-safely.ts} --- Funkce pro přesun focusu na element bez vedlejších efektů pro odečítače obrazovky.
    \item \textbf{focus-without-scrolling.ts} --- Funkce pro přesun focusu na element bez posunu stránky.
    \item \textbf{focus.ts} --- Funkce pro přesun focusu v rámci elementu.
    \item \textbf{interactions.ts} --- Kód, který detekuje jakým způsobem uživatel interaguje se stránkou (klávesnice, dotek, nebo virtualizované klikání)
    \item \textbf{is-element-visible.ts} --- Funkce kontrolující zda je daný element viditelný.
    \item \textbf{is-virtual-click.ts} --- Funkce detekující virtuální klikání.
    \item \textbf{live-announcer.ts} --- Třída \texttt{LiveAnnouncer}, která přidává neviditelné elementy do \gls{dom} s oznámením změn pro odečítače obrazovky.
    \item \textbf{platform.ts} --- Funkce pro detekci platformy na kterém běží kód. Slouží pro případnou korekci chování v různých prohlížečích.
    \item \textbf{run-after-transition.ts} --- Funkce, která zavolá callback funkci jakmile skončí všechny přechody v rámci stránky.
\end{itemize}

Samotná implementace komponenty exportuje funkci \texttt{createToolbar}, která vrací objekt s properties \texttt{toolbarProps} a nepovinně \texttt{toolbarRef} pro předání reference za pomocí direktivy pokud nebyla reference předána jako druhý argument.
První argument přijímá objekt s property \texttt{orientation} (požadavek \hyperref[tfr12]{\fr{TFR 1.2}}), která určuje zda je klávesová navigace horizontální nebo vertikální.

\begin{lstlisting}[caption={Ukázka implementace Toolbar komponenty}, label={toolbar-example}, language=html]
export const Toolbar: VoidComponent<Props> = (props) => {
    const {
        toolbarProps,
        toolbarRef
    } = createToolbar<HTMLDivElement>({
        orientation: "horizontal"
    });

    return (
        <div use:toolbarRef {...toolbarProps}>
            <button onClick={() => alert("Bold")}>
                Bold
            </button>

            <button onClick={() => alert("Italics")}>
                Italics
            </button>

            <button disabled>
                Underline
            </button>
        </div>
    );
};
\end{lstlisting}

Požadavek \hyperref[tfr11]{\fr{TFR 1.1}} je splněn pomocí \texttt{toolbarProps} objektu, který je předán na kořenový element komponenty.
Kořenový element, tak může obsahovat libovolný počet \textit{children} objektů, které se skládají z focusovatelných elementů či subkomponent a oddělovačů obsahu.

\clearpage

\section{Dokumentace}

TODO

\begin{lstlisting}[caption={Ukázka stránky dokumentace psané v MDX}, label={docs-page-example}, language=html]
---(*@\label{docs-page-example-1}@*)
title: Toolbar
description: a primitive for creating a Toolbar component
sidebar:
    badge:
        text: v0
        variant: success
---(*@\label{docs-page-example-8}@*)

<Links github="https://example.com" />(*@\label{docs-page-example-10}@*)

## Anatomy

<Anatomy viewBox="0 0 64 64" alt="0" caption="Example">
    <ToolbarAnatomy />
</Anatomy>

## API Reference

<PropTable name="ToolbarArguments" />(*@\label{docs-page-example-20}@*)

## Example

<Toolbar client:idle />(*@\label{docs-page-example-24}@*)
\end{lstlisting}

Na ukázce~\ref{docs-page-example} řádek~\ref{docs-page-example-1} až~\ref{docs-page-example-8} definuje tzv. \textit{frontmatter}, který obsahuje metadata o stránce jako je název a popis.
Komponenta \fr{Links} (řádek~\ref{docs-page-example-10}) je Astro komponenta, která zobrazuje odkazy na různé užitečné zdroje jako je zdrojový kód, \gls{apg} dokumentace dané komponenty, pokrytí kódu, nebo vygenerovaná typedoc dokumentace.
Další užitečnou Astro komponentou je \fr{PropTable} (řádek~\ref{docs-page-example-20}), která zobrazuje tabulku argumentů včetně výchozích hodnot a jejich typu.
V neposlední řadě na řádku~\ref{docs-page-example-24} je ukázka použití implementované komponenty v Solid.js, v tomto případě se jedná o Toolbar.
Direktiva \texttt{client:idle} je specifická pro Astro, která nám říká jakým způsobem se má komponenta \gls{hydratace}.

\section{Demo aplikace}

Důležitým aspektem pro demo aplikaci je co nejbližší simulace reálného prostředí, kde se komponenty budou používat.
Pro tento účel jsem zvolil meta-framework \fr{SolidStart}. Meta-framework je své podstatě framework postavený nad vícero frameworky, který zjednodušuje různé aspekty vývoje.
V kontextu meta-frameworků na webu se může jednat například o \gls{ssr}, \textit{routing} a \textit{serverless} funkce~\cite{prismic-metaframework}.

\fr{SolidStart} je oficiálně podporovaný a vyvíjený autorem Ryanem Carniatem, který je také autorem Solid.js.
Výhoda testování komponent v prostředí meta-frameworku spočívá v tom, že komponenta je vystavená různým kontextům jako je \gls{ssr}, \gls{ssg} a \gls{csr}.
